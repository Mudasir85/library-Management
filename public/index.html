<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Library Management</title>
    <style>
      :root {
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #0f766e;
        --primary-dark: #115e59;
        --danger: #b91c1c;
        --border: #e5e7eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(180deg, #ecfeff 0%, var(--bg) 45%);
        color: var(--text);
      }

      .container {
        max-width: 980px;
        margin: 28px auto;
        padding: 0 16px;
      }

      h1 {
        margin: 0 0 16px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
      }

      form {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .full {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      input,
      select,
      button {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
      }

      input:focus,
      select:focus {
        outline: 2px solid #99f6e4;
        border-color: var(--primary);
      }

      .btn-row {
        display: flex;
        gap: 8px;
      }

      button {
        cursor: pointer;
        border: none;
      }

      .primary {
        background: var(--primary);
        color: #ffffff;
      }

      .primary:hover {
        background: var(--primary-dark);
      }

      .secondary {
        background: #e5e7eb;
        color: #111827;
      }

      .danger {
        background: var(--danger);
        color: #ffffff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        border-bottom: 1px solid var(--border);
        text-align: left;
        padding: 10px;
      }

      th {
        color: var(--muted);
        font-weight: 600;
      }

      .actions {
        display: flex;
        gap: 8px;
      }

      .message {
        font-size: 14px;
        margin-bottom: 12px;
        min-height: 20px;
      }

      .message.error {
        color: var(--danger);
      }

      .message.success {
        color: #166534;
      }

      @media (max-width: 768px) {
        form {
          grid-template-columns: 1fr;
        }

        table,
        thead,
        tbody,
        tr,
        td,
        th {
          display: block;
        }

        thead {
          display: none;
        }

        tr {
          border: 1px solid var(--border);
          border-radius: 8px;
          margin-bottom: 10px;
          padding: 8px;
        }

        td {
          border: 0;
          padding: 6px 4px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Library Management</h1>
      <div class="grid">
        <section class="card">
          <h2 id="form-title">Add User</h2>
          <p id="message" class="message"></p>
          <form id="user-form">
            <div>
              <label for="full_name">Full Name</label>
              <input id="full_name" name="full_name" minlength="2" maxlength="50" required />
            </div>

            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required />
            </div>

            <div>
              <label for="phone">Phone (10 digits)</label>
              <input
                id="phone"
                name="phone"
                inputmode="numeric"
                maxlength="10"
                pattern="\d{10}"
                title="Enter exactly 10 digits"
                required
              />
            </div>

            <div>
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="Admin">Admin</option>
                <option value="User" selected>User</option>
                <option value="Guest">Guest</option>
              </select>
            </div>

            <div class="full">
              <label for="password">Password</label>
              <input id="password" name="password" type="password" minlength="8" required />
            </div>

            <div class="full btn-row">
              <button id="submit-btn" class="primary" type="submit">Add User</button>
              <button id="cancel-btn" class="secondary" type="button" style="display: none">
                Cancel Edit
              </button>
            </div>
          </form>
        </section>

        <section class="card">
          <h2>Users List</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-body"></tbody>
          </table>
        </section>
      </div>
    </div>

    <script>
      const form = document.getElementById('user-form');
      const message = document.getElementById('message');
      const usersBody = document.getElementById('users-body');
      const formTitle = document.getElementById('form-title');
      const submitBtn = document.getElementById('submit-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const passwordInput = document.getElementById('password');
      const phoneInput = document.getElementById('phone');

      let editingId = null;
      let usersCache = [];

      function escapeHtml(value) {
        return String(value)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      function setMessage(text, isError = false) {
        message.textContent = text;
        message.className = `message ${isError ? 'error' : 'success'}`;
      }

      function clearMessage() {
        message.textContent = '';
        message.className = 'message';
      }

      function setSubmitting(isSubmitting) {
        submitBtn.disabled = isSubmitting;
        submitBtn.style.opacity = isSubmitting ? '0.7' : '1';
        submitBtn.textContent = isSubmitting
          ? editingId === null
            ? 'Adding...'
            : 'Updating...'
          : editingId === null
            ? 'Add User'
            : 'Update User';
      }

      function validatePayload(payload, isEdit = false) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^\d{10}$/;
        const roles = ['Admin', 'User', 'Guest'];

        if (payload.full_name.trim().length < 2 || payload.full_name.trim().length > 50) {
          return 'Full Name must be 2 to 50 characters.';
        }

        if (!emailRegex.test(payload.email.trim().toLowerCase())) {
          return 'Email must be a valid email address.';
        }

        if (!phoneRegex.test(payload.phone.trim())) {
          return 'Phone must be exactly 10 digits.';
        }

        if (!roles.includes(payload.role)) {
          return 'Role must be Admin, User, or Guest.';
        }

        if (!isEdit || payload.password.length > 0) {
          if (payload.password.length < 8) {
            return 'Password must be at least 8 characters.';
          }
        }

        return null;
      }

      async function requestJson(url, options = {}) {
        const response = await fetch(url, options);
        let data = null;
        try {
          data = await response.json();
        } catch (error) {
          data = null;
        }
        return { response, data };
      }

      async function loadUsers() {
        const { response, data } = await requestJson('/api/users');
        if (!response.ok || !Array.isArray(data)) {
          throw new Error('Failed to load users.');
        }

        const users = data;
        usersCache = users;

        if (users.length === 0) {
          usersBody.innerHTML =
            '<tr><td colspan="6" style="text-align:center;color:#6b7280;">No users found.</td></tr>';
          return;
        }

        usersBody.innerHTML = users
          .map(
            (user) => `
              <tr>
                <td>${user.id}</td>
                <td>${escapeHtml(user.full_name)}</td>
                <td>${escapeHtml(user.email)}</td>
                <td>${escapeHtml(user.phone)}</td>
                <td>${escapeHtml(user.role)}</td>
                <td>
                  <div class="actions">
                    <button class="secondary" onclick="viewUser(${user.id})">View</button>
                    <button class="secondary" onclick="editUser(${user.id})">Edit</button>
                    <button class="danger" onclick="deleteUser(${user.id})">Delete</button>
                  </div>
                </td>
              </tr>
            `
          )
          .join('');
      }

      function resetForm() {
        editingId = null;
        form.reset();
        document.getElementById('role').value = 'User';
        formTitle.textContent = 'Add User';
        submitBtn.textContent = 'Add User';
        cancelBtn.style.display = 'none';
        passwordInput.required = true;
        passwordInput.placeholder = '';
      }

      window.viewUser = function viewUser(id) {
        window.location.href = `/user-details/${id}`;
      };

      window.editUser = function editUser(id) {
        const user = usersCache.find((u) => u.id === id);
        if (!user) {
          return;
        }

        editingId = id;
        formTitle.textContent = `Edit User #${id}`;
        submitBtn.textContent = 'Update User';
        cancelBtn.style.display = 'inline-block';

        document.getElementById('full_name').value = user.full_name;
        document.getElementById('email').value = user.email;
        document.getElementById('phone').value = user.phone;
        document.getElementById('role').value = user.role;
        passwordInput.value = '';
        passwordInput.required = false;
        passwordInput.placeholder = 'Leave blank to keep current password';

        clearMessage();
      };

      window.deleteUser = async function deleteUser(id) {
        if (!confirm('Delete this user permanently?')) {
          return;
        }

        clearMessage();
        try {
          const { response, data } = await requestJson(`/api/users/${id}`, { method: 'DELETE' });

          if (!response.ok) {
            setMessage((data && data.message) || 'Failed to delete user.', true);
            return;
          }

          setMessage('User deleted successfully.');
          if (editingId === id) {
            resetForm();
          }
          await loadUsers();
        } catch (error) {
          setMessage('Failed to delete user.', true);
        }
      };

      cancelBtn.addEventListener('click', () => {
        resetForm();
        clearMessage();
      });

      phoneInput.addEventListener('input', () => {
        phoneInput.value = phoneInput.value.replace(/\D/g, '').slice(0, 10);
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        clearMessage();

        const payload = {
          full_name: document.getElementById('full_name').value,
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          role: document.getElementById('role').value,
          password: document.getElementById('password').value
        };

        const validationError = validatePayload(payload, editingId !== null);
        if (validationError) {
          setMessage(validationError, true);
          return;
        }

        const endpoint = editingId === null ? '/api/users' : `/api/users/${editingId}`;
        const method = editingId === null ? 'POST' : 'PUT';

        try {
          setSubmitting(true);
          const { response, data } = await requestJson(endpoint, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            setMessage((data && data.message) || 'Operation failed.', true);
            return;
          }

          setMessage(editingId === null ? 'User added successfully.' : 'User updated successfully.');
          resetForm();
          await loadUsers();
        } catch (error) {
          setMessage('Request failed. Please try again.', true);
        } finally {
          setSubmitting(false);
        }
      });

      loadUsers().catch(() => {
        setMessage('Failed to load users.', true);
      });
    </script>
  </body>
</html>
