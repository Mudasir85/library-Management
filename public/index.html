<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Management System - Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: #1a73e8;
      color: #fff;
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 100;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }

    .menu-toggle {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      display: none;
    }

    .menu-toggle:hover { background: rgba(255,255,255,0.15); }

    .header h1 { font-size: 20px; font-weight: 600; }
    .header h1 span { font-weight: 300; opacity: 0.9; }

    .header-right { display: flex; align-items: center; gap: 16px; }

    .user-info {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn-logout {
      color: #fff;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 7px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-logout:hover { background: rgba(255,255,255,0.25); }

    .layout {
      display: flex;
      margin-top: 60px;
      min-height: calc(100vh - 60px);
    }

    .sidebar {
      width: 250px;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      padding: 20px 0;
      position: fixed;
      top: 60px;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 90;
    }

    .sidebar-nav { list-style: none; }

    .sidebar-nav li {
      margin-bottom: 2px;
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: #555;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .sidebar-nav a:hover {
      background: #f0f4ff;
      color: #1a73e8;
    }

    .sidebar-nav a.active {
      background: #e8f0fe;
      color: #1a73e8;
      border-left-color: #1a73e8;
      font-weight: 600;
    }

    .sidebar-nav .nav-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .sidebar-section {
      padding: 8px 24px 6px;
      font-size: 11px;
      font-weight: 700;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 16px;
    }

    .main-content {
      flex: 1;
      margin-left: 250px;
      padding: 24px;
      min-height: calc(100vh - 60px);
    }

    .section { display: none; }
    .section.active { display: block; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
    }

    .stat-icon.users { background: #e8f0fe; color: #1a73e8; }
    .stat-icon.books { background: #fce8e6; color: #d93025; }
    .stat-icon.issued { background: #fff3cd; color: #856404; }

    .stat-info h3 {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }

    .stat-info p {
      font-size: 13px;
      color: #888;
      margin-top: 2px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-header h2 {
      font-size: 18px;
      color: #333;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #1a73e8;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }

    .form-group label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #555;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 70px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
    }

    .readonly-input {
      background: #f8f9fa;
      color: #666;
    }

    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 12px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .image-upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    .image-upload-area:hover {
      border-color: #1a73e8;
      background: #f8faff;
    }

    .image-upload-area input[type="file"] {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .image-upload-area .upload-icon { font-size: 32px; color: #aaa; margin-bottom: 8px; }
    .image-upload-area p { font-size: 13px; color: #888; }
    .image-upload-area .file-name { font-size: 12px; color: #1a73e8; margin-top: 6px; font-weight: 600; }

    .image-preview {
      max-width: 120px;
      max-height: 90px;
      border-radius: 4px;
      margin-top: 8px;
      object-fit: cover;
      border: 1px solid #e5e5e5;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary { background: #1a73e8; color: #fff; }
    .btn-primary:hover { background: #1557b0; }

    .btn-secondary { background: #e8eaed; color: #333; }
    .btn-secondary:hover { background: #d2d5db; }

    .btn-danger { background: #dc3545; color: #fff; padding: 6px 14px; font-size: 13px; }
    .btn-danger:hover { background: #b02a37; }

    .btn-edit { background: #ffc107; color: #333; padding: 6px 14px; font-size: 13px; }
    .btn-edit:hover { background: #e0a800; }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }

    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .popup-stack {
      position: fixed;
      top: 76px;
      right: 18px;
      z-index: 2200;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: min(360px, calc(100vw - 24px));
      pointer-events: none;
    }

    .popup-message {
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.16);
      border: 1px solid transparent;
      font-size: 14px;
      font-weight: 500;
      line-height: 1.4;
      transform: translateY(-8px);
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .popup-message.show {
      transform: translateY(0);
      opacity: 1;
    }

    .popup-success {
      background: #e8f7ed;
      color: #166534;
      border-color: #bbf7d0;
    }

    .popup-error {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .popup-confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2300;
      padding: 16px;
    }

    .popup-confirm-overlay.show {
      display: flex;
    }

    .popup-confirm {
      width: min(420px, 100%);
      background: #fff;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.2);
      border: 1px solid #e5e7eb;
    }

    .popup-confirm h3 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #111827;
    }

    .popup-confirm p {
      margin: 0;
      font-size: 14px;
      color: #374151;
      line-height: 1.5;
    }

    .popup-confirm-actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .table-wrapper { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #f8f9fa; }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      font-size: 14px;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      color: #555;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tbody tr:hover { background: #f8f9fa; }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 15px;
    }

    .role-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .role-admin { background: #e8d5f5; color: #6f42c1; }
    .role-user { background: #d4edda; color: #155724; }
    .role-guest { background: #fff3cd; color: #856404; }

    .book-thumb,
    .user-avatar {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #eee;
      background: #fff;
    }

    .avatar-small {
      width: 36px;
      height: 36px;
      object-fit: cover;
      border-radius: 50%;
      border: 1px solid #eee;
    }

    .book-thumb-placeholder,
    .avatar-placeholder {
      width: 50px;
      height: 50px;
      background: #f0f2f5;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #ccc;
    }

    .avatar-placeholder.small {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 14px;
    }

    .badge-available,
    .badge-not-available,
    .badge-issued,
    .badge-returned,
    .badge-overdue,
    .badge-pending,
    .badge-collected,
    .badge-online,
    .badge-offline {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-available { background: #d4edda; color: #155724; }
    .badge-not-available { background: #f8d7da; color: #721c24; }
    .badge-issued { background: #fff3cd; color: #856404; }
    .badge-returned { background: #d4edda; color: #155724; }
    .badge-overdue { background: #f8d7da; color: #721c24; }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-collected { background: #d4edda; color: #155724; }
    .badge-online { background: #dbeafe; color: #1d4ed8; }
    .badge-offline { background: #f1f5f9; color: #334155; }

    .btn-return {
      background: #28a745;
      color: #fff;
      padding: 6px 14px;
      font-size: 13px;
    }

    .btn-return:hover { background: #218838; }

    .btn-collect {
      background: #1a73e8;
      color: #fff;
      padding: 6px 14px;
      font-size: 13px;
    }

    .btn-collect:hover { background: #1557b0; }

    .search-box {
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      width: 300px;
      max-width: 100%;
      transition: border-color 0.2s;
    }

    .search-box:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
    }

    .issue-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .summary-icon {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .summary-icon.s-issued { background: #fff3cd; color: #856404; }
    .summary-icon.s-returned { background: #d4edda; color: #155724; }
    .summary-icon.s-overdue { background: #f8d7da; color: #721c24; }

    .summary-info h3 { font-size: 24px; font-weight: 700; color: #333; }
    .summary-info p { font-size: 12px; color: #888; margin-top: 2px; }

    .welcome-card {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      border-radius: 10px;
      padding: 28px 32px;
      margin-bottom: 24px;
      color: #fff;
    }

    .welcome-card h2 { font-size: 22px; font-weight: 600; margin-bottom: 6px; color: #fff; }
    .welcome-card p { font-size: 14px; opacity: 0.9; }

    .hint-text {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 80;
    }

    @media (max-width: 900px) {
      .menu-toggle { display: block; }

      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay.open {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: 16px;
      }

      .form-grid { grid-template-columns: 1fr; }
      .dashboard-grid { grid-template-columns: 1fr; }
      .issue-summary-grid { grid-template-columns: 1fr; }
      .search-box { width: 100%; }
      .header h1 { font-size: 16px; }
      .user-info { display: none; }
    }
  </style>
</head>
<body>
  <div id="popupStack" class="popup-stack" aria-live="polite" aria-atomic="true"></div>
  <div id="popupConfirmOverlay" class="popup-confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="popupConfirmTitle">
    <div class="popup-confirm">
      <h3 id="popupConfirmTitle">Please Confirm</h3>
      <p id="popupConfirmMessage"></p>
      <div class="popup-confirm-actions">
        <button id="popupConfirmCancel" type="button" class="btn btn-secondary">Cancel</button>
        <button id="popupConfirmOk" type="button" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <div class="header">
    <div class="header-left">
      <button class="menu-toggle" onclick="toggleSidebar()">&#9776;</button>
      <h1>&#128218; Library <span>Management</span></h1>
    </div>
    <div class="header-right">
      <span class="user-info" id="headerUser">Welcome, Admin</span>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
      <div class="sidebar-section">Main</div>
      <ul class="sidebar-nav">
        <li>
          <a href="#" class="active" data-section="dashboard" onclick="navigateTo('dashboard', this, event)">
            <span class="nav-icon">&#127968;</span> Dashboard
          </a>
        </li>
      </ul>
      <div class="sidebar-section">Management</div>
      <ul class="sidebar-nav">
        <li>
          <a href="#" data-section="users" onclick="navigateTo('users', this, event)">
            <span class="nav-icon">&#128101;</span> Users
          </a>
        </li>
        <li>
          <a href="#" data-section="book-master" onclick="navigateTo('book-master', this, event)">
            <span class="nav-icon">&#128213;</span> Book Master
          </a>
        </li>
        <li>
          <a href="#" data-section="class-master" onclick="navigateTo('class-master', this, event)">
            <span class="nav-icon">&#127891;</span> Branch/Class Master
          </a>
        </li>
        <li>
          <a href="#" data-section="books" onclick="navigateTo('books', this, event)">
            <span class="nav-icon">&#128214;</span> Books
          </a>
        </li>
        <li>
          <a href="#" data-section="issue-books" onclick="navigateTo('issue-books', this, event)">
            <span class="nav-icon">&#128196;</span> Issue Books
          </a>
        </li>
        <li>
          <a href="#" data-section="fines" onclick="navigateTo('fines', this, event)">
            <span class="nav-icon">&#128176;</span> Fines
          </a>
        </li>
        <li>
          <a href="#" data-section="fine-payments" onclick="navigateTo('fine-payments', this, event)">
            <span class="nav-icon">&#128179;</span> Fine Payments
          </a>
        </li>
      </ul>
      <div class="sidebar-section">Other</div>
      <ul class="sidebar-nav">
        <li>
          <a href="/mohit/contact.html">
            <span class="nav-icon">&#9993;</span> Contact Us
          </a>
        </li>
      </ul>
    </nav>

    <div class="main-content">

      <div id="section-dashboard" class="section active">
        <div class="welcome-card">
          <h2>Welcome to Library Dashboard</h2>
          <p>Manage users, books, masters, issue records and fines from one place.</p>
        </div>

        <div class="dashboard-grid">
          <div class="stat-card" onclick="navigateTo('users', document.querySelector('[data-section=users]'))">
            <div class="stat-icon users">&#128101;</div>
            <div class="stat-info">
              <h3 id="totalUsers">0</h3>
              <p>Total Users</p>
            </div>
          </div>
          <div class="stat-card" onclick="navigateTo('books', document.querySelector('[data-section=books]'))">
            <div class="stat-icon books">&#128214;</div>
            <div class="stat-info">
              <h3 id="totalBooks">0</h3>
              <p>Total Books</p>
            </div>
          </div>
          <div class="stat-card" onclick="navigateTo('issue-books', document.querySelector('[data-section=issue-books]'))">
            <div class="stat-icon issued">&#128196;</div>
            <div class="stat-info">
              <h3 id="totalIssued">0</h3>
              <p>Books Issued</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Recent Users</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody id="recentUsersBody">
                <tr><td colspan="5" class="empty-state">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Recent Books</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Image</th>
                  <th>Book Name</th>
                  <th>Author</th>
                  <th>Class</th>
                </tr>
              </thead>
              <tbody id="recentBooksBody">
                <tr><td colspan="5" class="empty-state">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-users" class="section">
        <div id="userAlert" class="alert"></div>

        <div class="card">
          <h2 id="userFormTitle">Add New User</h2>
          <form id="userForm" enctype="multipart/form-data">
            <input type="hidden" id="userId">
            <div class="form-grid">
              <div class="form-group">
                <label for="fullName">Full Name *</label>
                <input type="text" id="fullName" placeholder="Enter full name" required minlength="2" maxlength="50">
              </div>
              <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" placeholder="Enter email" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone *</label>
                <input type="text" id="phone" placeholder="Enter 10-digit phone" required pattern="\d{10}" maxlength="10">
              </div>
              <div class="form-group">
                <label for="role">Role *</label>
                <select id="role" required>
                  <option value="">Select Role</option>
                  <option value="Admin">Admin</option>
                  <option value="User">User</option>
                  <option value="Guest">Guest</option>
                </select>
              </div>
              <div class="form-group">
                <label for="password" id="passwordLabel">Password *</label>
                <input type="password" id="password" placeholder="Min 8 characters" required minlength="8">
              </div>
              <div class="form-group full-width">
                <label>User Profile Image (optional)</label>
                <div class="image-upload-area">
                  <div class="upload-icon">&#128247;</div>
                  <p>Click to upload profile image</p>
                  <p class="file-name" id="userFileName"></p>
                  <img id="userImagePreview" class="image-preview" style="display:none;" alt="User Preview">
                  <input type="file" id="userImage" accept="image/jpeg,image/png,image/gif,image/webp" onchange="previewUserImage(this)">
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="userSubmitBtn">Add User</button>
                <button type="button" class="btn btn-secondary" id="userCancelBtn" style="display:none;" onclick="resetUserForm()">Cancel</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Users List</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="7" class="empty-state">Loading users...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-book-master" class="section">
        <div id="bookMasterAlert" class="alert"></div>

        <div class="card">
          <h2 id="bookMasterFormTitle">Add Book Master</h2>
          <form id="bookMasterForm">
            <input type="hidden" id="bookMasterId">
            <div class="form-grid">
              <div class="form-group">
                <label for="masterBookName">Book Name *</label>
                <input type="text" id="masterBookName" required minlength="2" maxlength="100" placeholder="Book name">
              </div>
              <div class="form-group">
                <label for="masterAuthorName">Author *</label>
                <input type="text" id="masterAuthorName" required minlength="2" maxlength="100" placeholder="Author name">
              </div>
              <div class="form-group">
                <label for="masterPublisherName">Publisher *</label>
                <input type="text" id="masterPublisherName" required minlength="2" maxlength="100" placeholder="Publisher name">
              </div>
              <div class="form-group">
                <label for="masterIsbn">ISBN (optional)</label>
                <input type="text" id="masterIsbn" maxlength="20" placeholder="ISBN number">
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="bookMasterSubmitBtn">Add Book Master</button>
                <button type="button" class="btn btn-secondary" id="bookMasterCancelBtn" style="display:none;" onclick="resetBookMasterForm()">Cancel</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Book Master List</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Book Name</th>
                  <th>Author</th>
                  <th>Publisher</th>
                  <th>ISBN</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="bookMasterBody">
                <tr><td colspan="6" class="empty-state">Loading book master data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-class-master" class="section">
        <div id="classMasterAlert" class="alert"></div>

        <div class="card">
          <h2 id="classMasterFormTitle">Add Branch/Class</h2>
          <form id="classMasterForm">
            <input type="hidden" id="classMasterId">
            <div class="form-grid">
              <div class="form-group">
                <label for="className">Class/Branch Name *</label>
                <input type="text" id="className" required maxlength="100" placeholder="e.g. Class 10, Science, Main Branch">
              </div>
              <div class="form-group">
                <label for="classDescription">Description (optional)</label>
                <textarea id="classDescription" maxlength="300" placeholder="Optional description"></textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="classMasterSubmitBtn">Add Class</button>
                <button type="button" class="btn btn-secondary" id="classMasterCancelBtn" style="display:none;" onclick="resetClassMasterForm()">Cancel</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Class/Branch Master List</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Class/Branch Name</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="classMasterBody">
                <tr><td colspan="4" class="empty-state">Loading class master data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-books" class="section">
        <div id="bookAlert" class="alert"></div>

        <div class="card">
          <h2 id="bookFormTitle">Add New Book</h2>
          <form id="bookForm" enctype="multipart/form-data">
            <input type="hidden" id="bookId">
            <div class="form-grid">
              <div class="form-group">
                <label for="bookMasterSelect">Book Name *</label>
                <select id="bookMasterSelect" required onchange="onBookMasterChange()">
                  <option value="">Select Book from Book Master</option>
                </select>
                <div class="hint-text">Values are loaded from Book Master.</div>
              </div>
              <div class="form-group">
                <label for="bookClassSelect">Class *</label>
                <select id="bookClassSelect" required>
                  <option value="">Select Class from Branch/Class Master</option>
                </select>
                <div class="hint-text">Values are loaded from Branch/Class Master.</div>
              </div>
              <div class="form-group">
                <label for="authorName">Author Name</label>
                <input type="text" id="authorName" class="readonly-input" readonly>
              </div>
              <div class="form-group">
                <label for="publisherName">Publisher Name</label>
                <input type="text" id="publisherName" class="readonly-input" readonly>
              </div>
              <div class="form-group">
                <label for="isbn">ISBN</label>
                <input type="text" id="isbn" class="readonly-input" readonly>
              </div>
              <div class="form-group">
                <label for="totalCopies">Total Copies *</label>
                <input type="number" id="totalCopies" placeholder="Number of copies" required min="1" max="9999" value="1">
              </div>
              <div class="form-group full-width">
                <label>Book Image (optional)</label>
                <div class="image-upload-area">
                  <div class="upload-icon">&#128247;</div>
                  <p>Click to upload an image</p>
                  <p class="file-name" id="bookFileName"></p>
                  <img id="bookImagePreview" class="image-preview" style="display:none;" alt="Book Preview">
                  <input type="file" id="bookImage" accept="image/jpeg,image/png,image/gif,image/webp" onchange="previewBookImage(this)">
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="bookSubmitBtn">Add Book</button>
                <button type="button" class="btn btn-secondary" id="bookCancelBtn" style="display:none;" onclick="resetBookForm()">Cancel</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Books List</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Image</th>
                  <th>Book Name</th>
                  <th>Class</th>
                  <th>Author</th>
                  <th>Publisher</th>
                  <th>Total Copies</th>
                  <th>Available</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="booksTableBody">
                <tr><td colspan="10" class="empty-state">Loading books...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-issue-books" class="section">
        <div id="issueAlert" class="alert"></div>

        <div class="issue-summary-grid">
          <div class="summary-card">
            <div class="summary-icon s-issued">&#128196;</div>
            <div class="summary-info">
              <h3 id="summaryIssued">0</h3>
              <p>Currently Issued</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon s-returned">&#9989;</div>
            <div class="summary-info">
              <h3 id="summaryReturned">0</h3>
              <p>Returned</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon s-overdue">&#9888;</div>
            <div class="summary-info">
              <h3 id="summaryOverdue">0</h3>
              <p>Overdue</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Issue a Book</h2>
          <form id="issueForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="issueBook">Select Book *</label>
                <select id="issueBook" required>
                  <option value="">Select a Book</option>
                </select>
              </div>
              <div class="form-group">
                <label for="issueUser">Select User *</label>
                <select id="issueUser" required>
                  <option value="">Select a User</option>
                </select>
              </div>
              <div class="form-group">
                <label for="issueDate">Issue Date</label>
                <input type="date" id="issueDate" required>
              </div>
              <div class="form-group">
                <label for="dueDate">Due Date (Optional)</label>
                <input type="date" id="dueDate">
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Issue Book</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Issued Books</h2>
            <input type="text" class="search-box" id="issueSearchBox" placeholder="Search by book, user, email, status..." oninput="filterIssuedBooks()">
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Book Name</th>
                  <th>Author</th>
                  <th>Issued To</th>
                  <th>Email</th>
                  <th>Issue Date</th>
                  <th>Due Date</th>
                  <th>Return Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="issuedBooksBody">
                <tr><td colspan="10" class="empty-state">Loading issued books...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-fines" class="section">
        <div id="fineAlert" class="alert"></div>

        <div class="issue-summary-grid">
          <div class="summary-card">
            <div class="summary-icon s-returned">&#128181;</div>
            <div class="summary-info">
              <h3 id="summaryCollectedFines">0</h3>
              <p>Total Collected Fines</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon s-overdue">&#128184;</div>
            <div class="summary-info">
              <h3 id="summaryPendingFines">0</h3>
              <p>Total Pending Fines</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Fines List</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Fine ID</th>
                  <th>User</th>
                  <th>Book Title</th>
                  <th>Days Overdue</th>
                  <th>Fine Amount</th>
                  <th>Payment Type</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="finesTableBody">
                <tr><td colspan="8" class="empty-state">Loading fines...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-fine-payments" class="section">
        <div id="finePaymentAlert" class="alert"></div>
        <div class="card">
          <div class="card-header">
            <h2>Fine Payment Records</h2>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Payment ID</th>
                  <th>Fine ID</th>
                  <th>User</th>
                  <th>Book</th>
                  <th>Amount</th>
                  <th>Payment Type</th>
                  <th>Payment Status</th>
                  <th>Gateway / Mode</th>
                  <th>Reference</th>
                  <th>Paid At</th>
                </tr>
              </thead>
              <tbody id="finePaymentsTableBody">
                <tr><td colspan="10" class="empty-state">Loading payment records...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-collect-fine" class="section">
        <div id="collectFineAlert" class="alert"></div>
        <div class="card">
          <div class="card-header">
            <h2>Collect Fine Payment</h2>
          </div>
          <form id="collectFineForm" onsubmit="submitFineCollectionForm(event)">
            <input type="hidden" id="collectFineId">
            <div class="form-grid">
              <div class="form-group">
                <label>Fine ID</label>
                <input type="text" id="collectFineDisplayId" disabled>
              </div>
              <div class="form-group">
                <label>User</label>
                <input type="text" id="collectFineUser" disabled>
              </div>
              <div class="form-group">
                <label>Book</label>
                <input type="text" id="collectFineBook" disabled>
              </div>
              <div class="form-group">
                <label>Days Overdue</label>
                <input type="text" id="collectFineDaysOverdue" disabled>
              </div>
              <div class="form-group">
                <label>Fine Amount</label>
                <input type="text" id="collectFineAmount" disabled>
              </div>
              <div class="form-group">
                <label>Status</label>
                <input type="text" id="collectFineStatus" disabled>
              </div>
              <div class="form-group">
                <label for="collectPaymentType">Payment Method</label>
                <select id="collectPaymentType" onchange="toggleCollectPaymentFields()" required>
                  <option value="">Select payment method</option>
                  <option value="Offline">Offline</option>
                  <option value="Online">Online (PayPal)</option>
                </select>
              </div>
              <div class="form-group" id="collectOfflineRefWrap" style="display:none;">
                <label for="collectOfflineRef">Office Receipt/Reference</label>
                <input type="text" id="collectOfflineRef" maxlength="60" placeholder="Optional office receipt/reference">
              </div>
              <div id="collectOnlineWrap" class="form-grid" style="display:none; grid-column: 1 / -1;">
                <div class="form-group">
                  <label>PayPal Checkout</label>
                  <p style="font-size: 0.86rem; color: #4b5563; margin-bottom: 8px;">Click the PayPal button below to complete online payment.</p>
                  <div id="collectPaypalButtonContainer"></div>
                </div>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="collectPaymentNotes">Notes (Optional)</label>
                <textarea id="collectPaymentNotes" rows="3" maxlength="200" placeholder="Optional payment note"></textarea>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" id="collectOfflineSubmitBtn" class="btn btn-primary">Complete Offline Payment</button>
              <button type="button" class="btn btn-warning" onclick="cancelFineCollection()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

<script>
  const BASE = '/mohit';

  let usersCache = [];
  let booksCache = [];
  let bookMasterCache = [];
  let classMasterCache = [];
  let allIssuedBooks = [];
  let finesCache = [];
  let selectedFineForCollection = null;
  let collectPayPalSdkLoaded = false;
  let collectPayPalButtonsRenderedForFineId = null;
  let collectPayPalConfig = null;

  document.getElementById('headerUser').textContent = 'Welcome, Admin';

  async function logout() {
    try {
      await fetch(BASE + '/api/logout', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' }
      });
    } catch {}
    sessionStorage.clear();
    document.cookie = 'session_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    document.cookie = 'session_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/mohit;';
    document.cookie = 'session_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/mohit/;';
    window.location.href = BASE + '/login.html';
  }

  function navigateTo(section, el, ev) {
    if (ev && typeof ev.preventDefault === 'function') {
      ev.preventDefault();
    }

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    const target = document.getElementById('section-' + section);
    if (target) target.classList.add('active');

    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
    if (el) el.classList.add('active');

    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('open');

    if (section === 'dashboard') loadDashboard();
    if (section === 'users') loadUsers();
    if (section === 'book-master') loadBookMaster();
    if (section === 'class-master') loadClassMaster();
    if (section === 'books') loadBooks();
    if (section === 'issue-books') loadIssueBooks();
    if (section === 'fines') loadFines();
    if (section === 'fine-payments') loadFinePayments();
  }

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('open');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text == null ? '' : String(text);
    return div.innerHTML;
  }

  function escapeAttr(text) {
    return String(text || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
  }

  function showPopupMessage(message, type) {
    const stack = document.getElementById('popupStack');
    if (!stack) return;

    const popup = document.createElement('div');
    const popupType = type === 'success' ? 'popup-success' : 'popup-error';
    popup.className = 'popup-message ' + popupType;
    popup.textContent = message;

    stack.appendChild(popup);
    requestAnimationFrame(() => popup.classList.add('show'));

    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => popup.remove(), 220);
    }, 4200);
  }

  function showAlert(elementId, message, type) {
    showPopupMessage(message, type);
  }

  function showConfirmPopup(message) {
    return new Promise((resolve) => {
      const overlay = document.getElementById('popupConfirmOverlay');
      const text = document.getElementById('popupConfirmMessage');
      const btnCancel = document.getElementById('popupConfirmCancel');
      const btnOk = document.getElementById('popupConfirmOk');

      text.textContent = message;
      overlay.classList.add('show');

      const cleanup = (result) => {
        overlay.classList.remove('show');
        btnCancel.removeEventListener('click', onCancel);
        btnOk.removeEventListener('click', onOk);
        overlay.removeEventListener('click', onOverlayClick);
        document.removeEventListener('keydown', onEsc);
        resolve(result);
      };

      const onCancel = () => cleanup(false);
      const onOk = () => cleanup(true);
      const onOverlayClick = (ev) => {
        if (ev.target === overlay) cleanup(false);
      };
      const onEsc = (ev) => {
        if (ev.key === 'Escape') cleanup(false);
      };

      btnCancel.addEventListener('click', onCancel);
      btnOk.addEventListener('click', onOk);
      overlay.addEventListener('click', onOverlayClick);
      document.addEventListener('keydown', onEsc);
      btnOk.focus();
    });
  }

  async function parseJsonResponse(res, fallbackMessage) {
    const raw = await res.text();
    try {
      return raw ? JSON.parse(raw) : {};
    } catch {
      const firstLine = String(raw || '').split('\n')[0].trim().slice(0, 80);
      throw new Error(firstLine || fallbackMessage || 'Server returned an invalid response');
    }
  }

  async function apiPostJson(apiPath, payload) {
    const paths = [BASE + apiPath, apiPath];
    let lastErr = null;

    for (let i = 0; i < paths.length; i += 1) {
      try {
        const res = await fetch(paths[i], {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload || {})
        });
        const data = await parseJsonResponse(res, 'Invalid server response');
        return { res, data };
      } catch (err) {
        lastErr = err;
      }
    }

    throw lastErr || new Error('Request failed');
  }

  async function apiGetJson(apiPath) {
    const paths = [BASE + apiPath, apiPath];
    let lastErr = null;

    for (let i = 0; i < paths.length; i += 1) {
      try {
        const res = await fetch(paths[i]);
        const data = await parseJsonResponse(res, 'Invalid server response');
        return { res, data };
      } catch (err) {
        lastErr = err;
      }
    }

    throw lastErr || new Error('Request failed');
  }

  function renderUserAvatar(path, small = false) {
    if (path) {
      const cls = small ? 'avatar-small' : 'user-avatar';
      return '<img src="' + BASE + escapeHtml(path) + '" class="' + cls + '" alt="User">';
    }
    if (small) {
      return '<div class="avatar-placeholder small">&#128100;</div>';
    }
    return '<div class="avatar-placeholder">&#128100;</div>';
  }

  async function loadDashboard() {
    try {
      const [statsRes, usersRes, booksRes] = await Promise.all([
        fetch(BASE + '/api/dashboard/stats'),
        fetch(BASE + '/api/users'),
        fetch(BASE + '/api/books')
      ]);

      const stats = await statsRes.json();
      usersCache = await usersRes.json();
      booksCache = await booksRes.json();

      document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
      document.getElementById('totalBooks').textContent = stats.totalBooks || 0;
      document.getElementById('totalIssued').textContent = stats.totalIssued || 0;

      const recentUsers = usersCache.slice(0, 5);
      const ruBody = document.getElementById('recentUsersBody');
      if (recentUsers.length === 0) {
        ruBody.innerHTML = '<tr><td colspan="5" class="empty-state">No users yet</td></tr>';
      } else {
        ruBody.innerHTML = recentUsers.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${renderUserAvatar(u.profile_image, true)}</td>
            <td>${escapeHtml(u.full_name)}</td>
            <td>${escapeHtml(u.email)}</td>
            <td><span class="role-badge role-${u.role.toLowerCase()}">${u.role}</span></td>
          </tr>
        `).join('');
      }

      const recentBooks = booksCache.slice(0, 5);
      const rbBody = document.getElementById('recentBooksBody');
      if (recentBooks.length === 0) {
        rbBody.innerHTML = '<tr><td colspan="5" class="empty-state">No books yet</td></tr>';
      } else {
        rbBody.innerHTML = recentBooks.map(b => `
          <tr>
            <td>${b.id}</td>
            <td>${b.book_image
              ? '<img src="' + BASE + escapeHtml(b.book_image) + '" class="book-thumb" alt="Book">'
              : '<div class="book-thumb-placeholder">&#128214;</div>'}</td>
            <td>${escapeHtml(b.book_name)}</td>
            <td>${escapeHtml(b.author_name)}</td>
            <td>${escapeHtml(b.class)}</td>
          </tr>
        `).join('');
      }
    } catch {
      console.error('Failed to load dashboard');
    }
  }

  async function loadUsers() {
    try {
      const res = await fetch(BASE + '/api/users');
      usersCache = await res.json();
      const tbody = document.getElementById('usersTableBody');

      if (!usersCache.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No users found. Add one above.</td></tr>';
        return;
      }

      tbody.innerHTML = usersCache.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>${renderUserAvatar(u.profile_image)}</td>
          <td>${escapeHtml(u.full_name)}</td>
          <td>${escapeHtml(u.email)}</td>
          <td>${escapeHtml(u.phone)}</td>
          <td><span class="role-badge role-${u.role.toLowerCase()}">${u.role}</span></td>
          <td class="actions">
            <button class="btn btn-edit" onclick="editUser(${u.id})">Edit</button>
            <button class="btn btn-danger" onclick="deleteUser(${u.id}, '${escapeAttr(u.full_name)}')">Delete</button>
          </td>
        </tr>
      `).join('');
    } catch {
      showAlert('userAlert', 'Failed to load users', 'error');
    }
  }

  function previewUserImage(input) {
    const preview = document.getElementById('userImagePreview');
    const fileName = document.getElementById('userFileName');

    if (input.files && input.files[0]) {
      const file = input.files[0];
      fileName.textContent = file.name;

      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      fileName.textContent = '';
    }
  }

  document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('userId').value;
    const full_name = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const role = document.getElementById('role').value;
    const password = document.getElementById('password').value;
    const userImage = document.getElementById('userImage').files[0];

    if (full_name.length < 2 || full_name.length > 50) {
      showAlert('userAlert', 'Full Name must be between 2 and 50 characters', 'error');
      return;
    }
    if (!/^\d{10}$/.test(phone)) {
      showAlert('userAlert', 'Phone must be exactly 10 digits', 'error');
      return;
    }
    if (!id && password.length < 8) {
      showAlert('userAlert', 'Password must be at least 8 characters', 'error');
      return;
    }
    if (id && password.length > 0 && password.length < 8) {
      showAlert('userAlert', 'Password must be at least 8 characters', 'error');
      return;
    }

    try {
      const isEdit = !!id;
      const url = isEdit ? BASE + '/api/users/' + id : BASE + '/api/users';
      const method = isEdit ? 'PUT' : 'POST';

      const formData = new FormData();
      formData.append('full_name', full_name);
      formData.append('email', email);
      formData.append('phone', phone);
      formData.append('role', role);
      formData.append('password', password);
      if (userImage) formData.append('profile_image', userImage);

      const res = await fetch(url, { method, body: formData });
      const result = await res.json();

      if (!res.ok) {
        showAlert('userAlert', result.error || 'Something went wrong', 'error');
        return;
      }

      showAlert('userAlert', isEdit ? 'User updated successfully' : 'User added successfully', 'success');
      resetUserForm();
      await loadUsers();
      loadDashboard();
    } catch {
      showAlert('userAlert', 'Failed to save user', 'error');
    }
  });

  function editUser(id) {
    const user = usersCache.find(u => Number(u.id) === Number(id));
    if (!user) return;

    document.getElementById('userId').value = user.id;
    document.getElementById('fullName').value = user.full_name;
    document.getElementById('email').value = user.email;
    document.getElementById('phone').value = user.phone;
    document.getElementById('role').value = user.role;
    document.getElementById('password').value = '';
    document.getElementById('password').required = false;
    document.getElementById('passwordLabel').textContent = 'Password (leave blank to keep current)';

    const preview = document.getElementById('userImagePreview');
    const fileName = document.getElementById('userFileName');
    if (user.profile_image) {
      preview.src = BASE + user.profile_image;
      preview.style.display = 'block';
      fileName.textContent = 'Current image (upload new to replace)';
    } else {
      preview.style.display = 'none';
      fileName.textContent = '';
    }

    document.getElementById('userFormTitle').textContent = 'Edit User #' + id;
    document.getElementById('userSubmitBtn').textContent = 'Update User';
    document.getElementById('userCancelBtn').style.display = 'inline-block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function deleteUser(id, name) {
    if (!(await showConfirmPopup('Are you sure you want to delete "' + name + '"?'))) return;

    try {
      const res = await fetch(BASE + '/api/users/' + id, { method: 'DELETE' });
      const result = await res.json();

      if (!res.ok) {
        showAlert('userAlert', result.error || 'Failed to delete user', 'error');
        return;
      }

      showAlert('userAlert', 'User deleted successfully', 'success');
      await loadUsers();
      loadDashboard();
    } catch {
      showAlert('userAlert', 'Failed to delete user', 'error');
    }
  }

  function resetUserForm() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('password').required = true;
    document.getElementById('passwordLabel').textContent = 'Password *';
    document.getElementById('userFormTitle').textContent = 'Add New User';
    document.getElementById('userSubmitBtn').textContent = 'Add User';
    document.getElementById('userCancelBtn').style.display = 'none';
    document.getElementById('userImagePreview').style.display = 'none';
    document.getElementById('userFileName').textContent = '';
  }

  async function loadBookMasterDropdown() {
    const res = await fetch(BASE + '/api/book-master');
    bookMasterCache = await res.json();

    const select = document.getElementById('bookMasterSelect');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select Book from Book Master</option>';
    bookMasterCache.forEach(item => {
      select.innerHTML += `<option value="${item.id}">${escapeHtml(item.book_name)}</option>`;
    });
    if (currentValue && bookMasterCache.some(x => String(x.id) === String(currentValue))) {
      select.value = currentValue;
    }
  }

  async function loadClassMasterDropdown() {
    const res = await fetch(BASE + '/api/class-master');
    classMasterCache = await res.json();

    const select = document.getElementById('bookClassSelect');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select Class from Branch/Class Master</option>';
    classMasterCache.forEach(item => {
      select.innerHTML += `<option value="${item.id}">${escapeHtml(item.class_name)}</option>`;
    });
    if (currentValue && classMasterCache.some(x => String(x.id) === String(currentValue))) {
      select.value = currentValue;
    }
  }

  function onBookMasterChange() {
    const id = document.getElementById('bookMasterSelect').value;
    const item = bookMasterCache.find(b => String(b.id) === String(id));
    document.getElementById('authorName').value = item ? item.author_name : '';
    document.getElementById('publisherName').value = item ? item.publisher_name : '';
    document.getElementById('isbn').value = item && item.isbn ? item.isbn : '';
  }

  async function loadBookMaster() {
    try {
      const res = await fetch(BASE + '/api/book-master');
      bookMasterCache = await res.json();
      const tbody = document.getElementById('bookMasterBody');

      if (!bookMasterCache.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No book master records found.</td></tr>';
      } else {
        tbody.innerHTML = bookMasterCache.map(b => `
          <tr>
            <td>${b.id}</td>
            <td>${escapeHtml(b.book_name)}</td>
            <td>${escapeHtml(b.author_name)}</td>
            <td>${escapeHtml(b.publisher_name)}</td>
            <td>${escapeHtml(b.isbn || '-')}</td>
            <td class="actions">
              <button class="btn btn-edit" onclick="editBookMaster(${b.id})">Edit</button>
              <button class="btn btn-danger" onclick="deleteBookMaster(${b.id}, '${escapeAttr(b.book_name)}')">Delete</button>
            </td>
          </tr>
        `).join('');
      }

      await loadBookMasterDropdown();
    } catch {
      showAlert('bookMasterAlert', 'Failed to load Book Master data', 'error');
    }
  }

  document.getElementById('bookMasterForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('bookMasterId').value;
    const data = {
      book_name: document.getElementById('masterBookName').value.trim(),
      author_name: document.getElementById('masterAuthorName').value.trim(),
      publisher_name: document.getElementById('masterPublisherName').value.trim(),
      isbn: document.getElementById('masterIsbn').value.trim()
    };

    try {
      const isEdit = !!id;
      const res = await fetch(isEdit ? BASE + '/api/book-master/' + id : BASE + '/api/book-master', {
        method: isEdit ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (!res.ok) {
        showAlert('bookMasterAlert', result.error || 'Failed to save Book Master record', 'error');
        return;
      }

      showAlert('bookMasterAlert', isEdit ? 'Book Master updated successfully' : 'Book Master added successfully', 'success');
      resetBookMasterForm();
      await loadBookMaster();
      loadBooks();
    } catch {
      showAlert('bookMasterAlert', 'Failed to save Book Master record', 'error');
    }
  });

  function editBookMaster(id) {
    const row = bookMasterCache.find(b => Number(b.id) === Number(id));
    if (!row) return;

    document.getElementById('bookMasterId').value = row.id;
    document.getElementById('masterBookName').value = row.book_name;
    document.getElementById('masterAuthorName').value = row.author_name;
    document.getElementById('masterPublisherName').value = row.publisher_name;
    document.getElementById('masterIsbn').value = row.isbn || '';
    document.getElementById('bookMasterFormTitle').textContent = 'Edit Book Master #' + id;
    document.getElementById('bookMasterSubmitBtn').textContent = 'Update Book Master';
    document.getElementById('bookMasterCancelBtn').style.display = 'inline-block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function deleteBookMaster(id, name) {
    if (!(await showConfirmPopup('Delete Book Master record "' + name + '"?'))) return;

    try {
      const res = await fetch(BASE + '/api/book-master/' + id, { method: 'DELETE' });
      const result = await res.json();
      if (!res.ok) {
        showAlert('bookMasterAlert', result.error || 'Failed to delete Book Master record', 'error');
        return;
      }

      showAlert('bookMasterAlert', 'Book Master record deleted successfully', 'success');
      await loadBookMaster();
      loadBooks();
    } catch {
      showAlert('bookMasterAlert', 'Failed to delete Book Master record', 'error');
    }
  }

  function resetBookMasterForm() {
    document.getElementById('bookMasterForm').reset();
    document.getElementById('bookMasterId').value = '';
    document.getElementById('bookMasterFormTitle').textContent = 'Add Book Master';
    document.getElementById('bookMasterSubmitBtn').textContent = 'Add Book Master';
    document.getElementById('bookMasterCancelBtn').style.display = 'none';
  }

  async function loadClassMaster() {
    try {
      const res = await fetch(BASE + '/api/class-master');
      classMasterCache = await res.json();
      const tbody = document.getElementById('classMasterBody');

      if (!classMasterCache.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No class/branch records found.</td></tr>';
      } else {
        tbody.innerHTML = classMasterCache.map(c => `
          <tr>
            <td>${c.id}</td>
            <td>${escapeHtml(c.class_name)}</td>
            <td>${escapeHtml(c.description || '-')}</td>
            <td class="actions">
              <button class="btn btn-edit" onclick="editClassMaster(${c.id})">Edit</button>
              <button class="btn btn-danger" onclick="deleteClassMaster(${c.id}, '${escapeAttr(c.class_name)}')">Delete</button>
            </td>
          </tr>
        `).join('');
      }

      await loadClassMasterDropdown();
    } catch {
      showAlert('classMasterAlert', 'Failed to load class/branch master data', 'error');
    }
  }

  document.getElementById('classMasterForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('classMasterId').value;
    const data = {
      class_name: document.getElementById('className').value.trim(),
      description: document.getElementById('classDescription').value.trim()
    };

    try {
      const isEdit = !!id;
      const res = await fetch(isEdit ? BASE + '/api/class-master/' + id : BASE + '/api/class-master', {
        method: isEdit ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (!res.ok) {
        showAlert('classMasterAlert', result.error || 'Failed to save class/branch record', 'error');
        return;
      }

      showAlert('classMasterAlert', isEdit ? 'Class/branch updated successfully' : 'Class/branch added successfully', 'success');
      resetClassMasterForm();
      await loadClassMaster();
      loadBooks();
    } catch {
      showAlert('classMasterAlert', 'Failed to save class/branch record', 'error');
    }
  });

  function editClassMaster(id) {
    const row = classMasterCache.find(c => Number(c.id) === Number(id));
    if (!row) return;

    document.getElementById('classMasterId').value = row.id;
    document.getElementById('className').value = row.class_name;
    document.getElementById('classDescription').value = row.description || '';
    document.getElementById('classMasterFormTitle').textContent = 'Edit Class/Branch #' + id;
    document.getElementById('classMasterSubmitBtn').textContent = 'Update Class';
    document.getElementById('classMasterCancelBtn').style.display = 'inline-block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function deleteClassMaster(id, name) {
    if (!(await showConfirmPopup('Delete class/branch "' + name + '"?'))) return;

    try {
      const res = await fetch(BASE + '/api/class-master/' + id, { method: 'DELETE' });
      const result = await res.json();
      if (!res.ok) {
        showAlert('classMasterAlert', result.error || 'Failed to delete class/branch', 'error');
        return;
      }

      showAlert('classMasterAlert', 'Class/branch deleted successfully', 'success');
      await loadClassMaster();
      loadBooks();
    } catch {
      showAlert('classMasterAlert', 'Failed to delete class/branch', 'error');
    }
  }

  function resetClassMasterForm() {
    document.getElementById('classMasterForm').reset();
    document.getElementById('classMasterId').value = '';
    document.getElementById('classMasterFormTitle').textContent = 'Add Branch/Class';
    document.getElementById('classMasterSubmitBtn').textContent = 'Add Class';
    document.getElementById('classMasterCancelBtn').style.display = 'none';
  }

  async function loadBooks() {
    try {
      const [booksRes] = await Promise.all([fetch(BASE + '/api/books'), loadBookMasterDropdown(), loadClassMasterDropdown()]);
      booksCache = await booksRes.json();

      const tbody = document.getElementById('booksTableBody');
      if (!booksCache.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No books found. Add one above.</td></tr>';
        return;
      }

      tbody.innerHTML = booksCache.map(b => {
        const totalCopies = b.total_copies || 1;
        const availableCopies = b.available_copies !== undefined ? b.available_copies : totalCopies;
        const statusBadge = availableCopies > 0
          ? '<span class="badge-available">Available</span>'
          : '<span class="badge-not-available">Not Available</span>';

        return `
          <tr>
            <td>${b.id}</td>
            <td>${b.book_image
              ? '<img src="' + BASE + escapeHtml(b.book_image) + '" class="book-thumb" alt="Book">'
              : '<div class="book-thumb-placeholder">&#128214;</div>'}</td>
            <td>${escapeHtml(b.book_name)}</td>
            <td>${escapeHtml(b.class)}</td>
            <td>${escapeHtml(b.author_name)}</td>
            <td>${escapeHtml(b.publisher_name)}</td>
            <td>${totalCopies}</td>
            <td>${availableCopies}</td>
            <td>${statusBadge}</td>
            <td class="actions">
              <button class="btn btn-edit" onclick="editBook(${b.id})">Edit</button>
              <button class="btn btn-danger" onclick="deleteBook(${b.id}, '${escapeAttr(b.book_name)}')">Delete</button>
            </td>
          </tr>`;
      }).join('');
    } catch {
      showAlert('bookAlert', 'Failed to load books', 'error');
    }
  }

  function previewBookImage(input) {
    const preview = document.getElementById('bookImagePreview');
    const fileName = document.getElementById('bookFileName');

    if (input.files && input.files[0]) {
      const file = input.files[0];
      fileName.textContent = file.name;

      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      fileName.textContent = '';
    }
  }

  document.getElementById('bookForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('bookId').value;
    const bookMasterId = document.getElementById('bookMasterSelect').value;
    const classMasterId = document.getElementById('bookClassSelect').value;
    const totalCopies = document.getElementById('totalCopies').value;
    const bookImage = document.getElementById('bookImage').files[0];

    if (!bookMasterId) {
      showAlert('bookAlert', 'Please select Book Name from Book Master', 'error');
      return;
    }
    if (!classMasterId) {
      showAlert('bookAlert', 'Please select Class from Branch/Class Master', 'error');
      return;
    }
    if (!totalCopies || parseInt(totalCopies, 10) < 1 || parseInt(totalCopies, 10) > 9999) {
      showAlert('bookAlert', 'Total Copies must be between 1 and 9999', 'error');
      return;
    }

    const formData = new FormData();
    formData.append('book_master_id', bookMasterId);
    formData.append('class_master_id', classMasterId);
    formData.append('total_copies', totalCopies);
    if (bookImage) formData.append('book_image', bookImage);

    try {
      const isEdit = !!id;
      const url = isEdit ? BASE + '/api/books/' + id : BASE + '/api/books';
      const method = isEdit ? 'PUT' : 'POST';

      const res = await fetch(url, { method, body: formData });
      const result = await res.json();

      if (!res.ok) {
        showAlert('bookAlert', result.error || 'Something went wrong', 'error');
        return;
      }

      showAlert('bookAlert', isEdit ? 'Book updated successfully' : 'Book added successfully', 'success');
      resetBookForm();
      await loadBooks();
      loadDashboard();
    } catch {
      showAlert('bookAlert', 'Failed to save book', 'error');
    }
  });

  async function editBook(id) {
    try {
      await Promise.all([loadBookMasterDropdown(), loadClassMasterDropdown()]);
      const book = booksCache.find(b => Number(b.id) === Number(id));
      if (!book) return;

      document.getElementById('bookId').value = book.id;
      document.getElementById('bookMasterSelect').value = book.book_master_id || '';
      onBookMasterChange();
      document.getElementById('bookClassSelect').value = book.class_master_id || '';
      document.getElementById('totalCopies').value = book.total_copies || 1;

      const preview = document.getElementById('bookImagePreview');
      const fileName = document.getElementById('bookFileName');
      if (book.book_image) {
        preview.src = BASE + book.book_image;
        preview.style.display = 'block';
        fileName.textContent = 'Current image (upload new to replace)';
      } else {
        preview.style.display = 'none';
        fileName.textContent = '';
      }

      document.getElementById('bookFormTitle').textContent = 'Edit Book #' + id;
      document.getElementById('bookSubmitBtn').textContent = 'Update Book';
      document.getElementById('bookCancelBtn').style.display = 'inline-block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch {
      showAlert('bookAlert', 'Failed to load book details', 'error');
    }
  }

  async function deleteBook(id, name) {
    if (!(await showConfirmPopup('Are you sure you want to delete "' + name + '"?'))) return;

    try {
      const res = await fetch(BASE + '/api/books/' + id, { method: 'DELETE' });
      const result = await res.json();

      if (!res.ok) {
        showAlert('bookAlert', result.error || 'Failed to delete book', 'error');
        return;
      }

      showAlert('bookAlert', 'Book deleted successfully', 'success');
      await loadBooks();
      loadDashboard();
    } catch {
      showAlert('bookAlert', 'Failed to delete book', 'error');
    }
  }

  function resetBookForm() {
    document.getElementById('bookForm').reset();
    document.getElementById('bookId').value = '';
    document.getElementById('totalCopies').value = 1;
    document.getElementById('bookImagePreview').style.display = 'none';
    document.getElementById('bookFileName').textContent = '';
    document.getElementById('authorName').value = '';
    document.getElementById('publisherName').value = '';
    document.getElementById('isbn').value = '';
    document.getElementById('bookFormTitle').textContent = 'Add New Book';
    document.getElementById('bookSubmitBtn').textContent = 'Add Book';
    document.getElementById('bookCancelBtn').style.display = 'none';
  }

  function formatYmd(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function setIssueDates() {
    document.getElementById('issueDate').value = '';
    document.getElementById('dueDate').value = '';
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const match = String(dateStr).match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (match) {
      const [, y, m, d] = match;
      return `${d}/${m}/${y}`;
    }
    const dt = new Date(dateStr);
    if (isNaN(dt.getTime())) return '-';
    const dd = String(dt.getDate()).padStart(2, '0');
    const mm = String(dt.getMonth() + 1).padStart(2, '0');
    const yy = dt.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function getPolicyDueDate(issueDateStr) {
    const issueDate = new Date(issueDateStr);
    if (isNaN(issueDate.getTime())) return null;
    issueDate.setHours(0, 0, 0, 0);
    issueDate.setDate(issueDate.getDate() + 14);
    return issueDate;
  }

  function getStatusInfo(ib) {
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    if (String(ib.status || '').trim().toLowerCase() === 'returned') {
      return { badge: '<span class="badge-returned">Returned</span>', label: 'Returned' };
    }

    const policyDueDate = getPolicyDueDate(ib.issue_date);
    if (policyDueDate && policyDueDate < now) {
      return { badge: '<span class="badge-overdue">Overdue</span>', label: 'Overdue' };
    }

    return { badge: '<span class="badge-issued">Issued</span>', label: 'Issued' };
  }

  function renderIssuedBooks(books) {
    const tbody = document.getElementById('issuedBooksBody');
    if (!books.length) {
      tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No books issued yet.</td></tr>';
      return;
    }

    tbody.innerHTML = books.map(ib => {
      const issueDate = formatDate(ib.issue_date);
      let dueDateDisplay;
      if (ib.due_date) {
        dueDateDisplay = formatDate(ib.due_date);
      } else {
        const policyDue = getPolicyDueDate(ib.issue_date);
        dueDateDisplay = policyDue ? formatDate(formatYmd(policyDue)) : '-';
      }
      const returnDate = formatDate(ib.return_date);
      const statusInfo = getStatusInfo(ib);
      let defaultReturnDate = formatYmd(new Date());
      if (ib.return_date) {
        const m = String(ib.return_date).match(/^(\d{4}-\d{2}-\d{2})/);
        defaultReturnDate = m ? m[1] : formatYmd(new Date(ib.return_date));
      }
      const isReturned = String(ib.status || '').trim().toLowerCase() === 'returned';
      const actionBtnLabel = isReturned ? 'Update Return Date' : 'Return';

      return `
      <tr>
        <td>${ib.id}</td>
        <td>${escapeHtml(ib.book_name)}</td>
        <td>${escapeHtml(ib.author_name)}</td>
        <td>${escapeHtml(ib.user_name)}</td>
        <td>${escapeHtml(ib.user_email)}</td>
        <td>${issueDate}</td>
        <td>${dueDateDisplay}</td>
        <td>${returnDate}</td>
        <td>${statusInfo.badge}</td>
        <td>
          <div class="actions" style="flex-wrap:wrap;gap:6px;">
            <input type="date" id="returnDate-${ib.id}" value="${defaultReturnDate}" style="padding:4px 6px;font-size:12px;border:1px solid #ddd;border-radius:4px;">
            <button class="btn btn-return" onclick="returnBook(${ib.id}, '${escapeAttr(ib.book_name)}')">${actionBtnLabel}</button>
            <button class="btn btn-danger" onclick="deleteIssuedBook(${ib.id}, '${escapeAttr(ib.book_name)}')">Delete</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  function filterIssuedBooks() {
    const query = document.getElementById('issueSearchBox').value.toLowerCase().trim();
    if (!query) {
      renderIssuedBooks(allIssuedBooks);
      return;
    }
    const filtered = allIssuedBooks.filter(ib => {
      const statusLabel = getStatusInfo(ib).label.toLowerCase();
      return (
        ib.book_name.toLowerCase().includes(query) ||
        ib.author_name.toLowerCase().includes(query) ||
        ib.user_name.toLowerCase().includes(query) ||
        ib.user_email.toLowerCase().includes(query) ||
        statusLabel.includes(query)
      );
    });
    renderIssuedBooks(filtered);
  }

  async function loadIssueSummary() {
    try {
      const res = await fetch(BASE + '/api/issued-books/summary');
      const summary = await res.json();
      document.getElementById('summaryIssued').textContent = summary.totalIssued || 0;
      document.getElementById('summaryReturned').textContent = summary.totalReturned || 0;
      document.getElementById('summaryOverdue').textContent = summary.totalOverdue || 0;
    } catch {}
  }

  async function loadIssueBooks() {
    try {
      setIssueDates();
      loadIssueSummary();

      const booksRes = await fetch(BASE + '/api/books/available');
      const availableBooks = await booksRes.json();
      const bookSelect = document.getElementById('issueBook');
      bookSelect.innerHTML = '<option value="">Select a Book</option>';
      availableBooks.forEach(b => {
        bookSelect.innerHTML += `<option value="${b.id}">${escapeHtml(b.book_name)} - ${escapeHtml(b.author_name)} (${b.available_copies} available)</option>`;
      });

      const usersRes = await fetch(BASE + '/api/users');
      usersCache = await usersRes.json();
      const userSelect = document.getElementById('issueUser');
      userSelect.innerHTML = '<option value="">Select a User</option>';
      usersCache.forEach(u => {
        userSelect.innerHTML += `<option value="${u.id}">${escapeHtml(u.full_name)} (${escapeHtml(u.email)})</option>`;
      });

      const issuedRes = await fetch(BASE + '/api/issued-books');
      allIssuedBooks = await issuedRes.json();

      document.getElementById('issueSearchBox').value = '';
      renderIssuedBooks(allIssuedBooks);
    } catch {
      showAlert('issueAlert', 'Failed to load issued books', 'error');
    }
  }

  document.getElementById('issueForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const book_id = document.getElementById('issueBook').value;
    const user_id = document.getElementById('issueUser').value;
    const issue_date = document.getElementById('issueDate').value;
    const due_date = document.getElementById('dueDate').value;

    if (!book_id) {
      showAlert('issueAlert', 'Please select a book', 'error');
      return;
    }
    if (!user_id) {
      showAlert('issueAlert', 'Please select a user', 'error');
      return;
    }
    if (!issue_date) {
      showAlert('issueAlert', 'Please select issue date', 'error');
      return;
    }
    if (due_date && due_date < issue_date) {
      showAlert('issueAlert', 'Due date cannot be earlier than issue date', 'error');
      return;
    }

    try {
      const res = await fetch(BASE + '/api/issued-books', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          book_id: parseInt(book_id, 10),
          user_id: parseInt(user_id, 10),
          issue_date,
          due_date: due_date || null
        })
      });

      const result = await res.json();

      if (!res.ok) {
        showAlert('issueAlert', result.error || 'Failed to issue book', 'error');
        return;
      }

      showAlert('issueAlert', 'Book issued successfully', 'success');
      document.getElementById('issueForm').reset();
      loadIssueBooks();
      loadDashboard();
    } catch {
      showAlert('issueAlert', 'Failed to issue book', 'error');
    }
  });

  async function returnBook(id, bookName) {
    const returnDateInput = document.getElementById('returnDate-' + id);
    const return_date = returnDateInput ? returnDateInput.value : '';
    if (!return_date) {
      showAlert('issueAlert', 'Please select return date', 'error');
      return;
    }

    if (!(await showConfirmPopup('Are you sure you want to return "' + bookName + '"?'))) return;

    try {
      const res = await fetch(BASE + '/api/issued-books/' + id + '/return', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ return_date })
      });
      const result = await res.json();

      if (!res.ok) {
        showAlert('issueAlert', result.error || 'Failed to return book', 'error');
        return;
      }

      showAlert('issueAlert', result.message || 'Book returned successfully', 'success');
      loadIssueBooks();
      loadDashboard();
    } catch {
      showAlert('issueAlert', 'Failed to return book', 'error');
    }
  }

  async function deleteIssuedBook(id, bookName) {
    if (!(await showConfirmPopup('Are you sure you want to delete the issued record for "' + bookName + '"? This action cannot be undone.'))) return;

    try {
      const res = await fetch(BASE + '/api/issued-books/' + id, { method: 'DELETE' });
      const result = await res.json();

      if (!res.ok) {
        showAlert('issueAlert', result.error || 'Failed to delete issued book record', 'error');
        return;
      }

      showAlert('issueAlert', 'Issued book record deleted successfully', 'success');
      loadIssueBooks();
      loadDashboard();
    } catch {
      showAlert('issueAlert', 'Failed to delete issued book record', 'error');
    }
  }

  function renderFines(fines) {
    const tbody = document.getElementById('finesTableBody');
    if (!fines || fines.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No Fine Found  Fines are auto-generated when books are overdue beyond 14 days from the issue date.</td></tr>';
      return;
    }

    tbody.innerHTML = fines.map((f) => {
      const statusNorm = String(f.status || '').trim().toLowerCase();
      const statusBadge = statusNorm === 'collected'
        ? '<span class="badge-collected">Collected</span>'
        : '<span class="badge-pending">Pending</span>';
      const paymentTypeNorm = String(f.payment_type || '').trim().toLowerCase();
      const paymentTypeBadge = paymentTypeNorm === 'online'
        ? '<span class="badge-online">Online</span>'
        : paymentTypeNorm === 'offline'
        ? '<span class="badge-offline">Office/Offline</span>'
        : '<span style="color:#888;">-</span>';
      const actionBtn = statusNorm === 'pending'
        ? `<button type="button" class="btn btn-collect" onclick="openFineCollectionPage(${Number(f.id || 0)})">Collect</button>`
        : '<span style="color:#888;">-</span>';
      return `
        <tr>
          <td>${f.id || '-'}</td>
          <td>${escapeHtml(f.user_name || 'Unknown User')}</td>
          <td>${escapeHtml(f.book_name || 'Unknown Book')}</td>
          <td>${Number(f.days_overdue || 0)}</td>
          <td>&#8377; ${Number(f.fine_amount || 0).toFixed(2)}</td>
          <td>${paymentTypeBadge}</td>
          <td>${statusBadge}</td>
          <td class="actions">${actionBtn}</td>
        </tr>
      `;
    }).join('');
  }

  async function loadFineSummary() {
    const { data: summary } = await apiGetJson('/api/fines/summary');
    document.getElementById('summaryCollectedFines').textContent = '\u20B9 ' + Number(summary.totalCollected || 0).toFixed(2);
    document.getElementById('summaryPendingFines').textContent = '\u20B9 ' + Number(summary.totalPending || 0).toFixed(2);
    return summary;
  }

  async function loadFines() {
    try {
      const summary = await loadFineSummary();
      const { data: fines } = await apiGetJson('/api/fines');
      finesCache = Array.isArray(fines) ? fines : [];
      const totalFineAmount = Number(summary.totalCollected || 0) + Number(summary.totalPending || 0);
      const visibleFines = finesCache.filter((f) => Number(f.fine_amount || 0) > 0);
      if (!visibleFines.length || totalFineAmount <= 0) {
        renderFines([]);
        return;
      }
      renderFines(visibleFines);
    } catch {
      showAlert('fineAlert', 'Failed to load fines', 'error');
    }
  }

  function setCollectFineFields(fine) {
    document.getElementById('collectFineId').value = fine.id || '';
    document.getElementById('collectFineDisplayId').value = fine.id || '-';
    document.getElementById('collectFineUser').value = fine.user_name || 'Unknown User';
    document.getElementById('collectFineBook').value = fine.book_name || 'Unknown Book';
    document.getElementById('collectFineDaysOverdue').value = Number(fine.days_overdue || 0);
    document.getElementById('collectFineAmount').value = '\u20B9 ' + Number(fine.fine_amount || 0).toFixed(2);
    document.getElementById('collectFineStatus').value = fine.status || 'Pending';
  }

  function resetCollectFineForm() {
    const form = document.getElementById('collectFineForm');
    form.reset();
    selectedFineForCollection = null;
    collectPayPalButtonsRenderedForFineId = null;
    const paypalContainer = document.getElementById('collectPaypalButtonContainer');
    if (paypalContainer) paypalContainer.innerHTML = '';
    document.getElementById('collectFineId').value = '';
    document.getElementById('collectFineDisplayId').value = '';
    document.getElementById('collectFineUser').value = '';
    document.getElementById('collectFineBook').value = '';
    document.getElementById('collectFineDaysOverdue').value = '';
    document.getElementById('collectFineAmount').value = '';
    document.getElementById('collectFineStatus').value = '';
    toggleCollectPaymentFields();
  }

  async function loadCollectPayPalSdk() {
    if (collectPayPalSdkLoaded && window.paypal) return;

    const { res: cfgRes, data: cfg } = await apiGetJson('/api/paypal/client-id');
    if (!cfgRes.ok) {
      throw new Error(cfg.error || 'PayPal is not configured');
    }
    collectPayPalConfig = cfg;

    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://www.paypal.com/sdk/js?client-id=' + encodeURIComponent(cfg.client_id) + '&currency=' + encodeURIComponent(cfg.currency || 'USD');
      script.onload = resolve;
      script.onerror = () => reject(new Error('Failed to load PayPal SDK'));
      document.head.appendChild(script);
    });

    collectPayPalSdkLoaded = true;
  }

  async function renderCollectPayPalButtons() {
    const fineId = Number(document.getElementById('collectFineId').value || 0);
    if (!fineId) return;
    if (collectPayPalButtonsRenderedForFineId === fineId) return;

    await loadCollectPayPalSdk();
    if (!window.paypal) throw new Error('PayPal SDK not available');

    const container = document.getElementById('collectPaypalButtonContainer');
    container.innerHTML = '';

    const onApproveHandler = async (data, actions) => {
        const paymentNotes = document.getElementById('collectPaymentNotes').value.trim();
        const payload = {
          payment_type: 'Online',
          payment_notes: paymentNotes,
          paypal_order_id: data.orderID
        };

        if (!(collectPayPalConfig && collectPayPalConfig.server_capture_enabled)) {
          const captureResult = await actions.order.capture();
          const purchaseUnit = captureResult && captureResult.purchase_units ? captureResult.purchase_units[0] : null;
          const captureInfo = purchaseUnit && purchaseUnit.payments && purchaseUnit.payments.captures ? purchaseUnit.payments.captures[0] : null;
          const captureId = captureInfo && captureInfo.id ? String(captureInfo.id).trim() : '';
          if (!captureId) {
            throw new Error('PayPal capture id not found');
          }

          payload.paypal_capture_id = captureId;
          payload.paypal_payer_email = String(captureResult?.payer?.email_address || '').trim();
          payload.paypal_payer_id = String(captureResult?.payer?.payer_id || '').trim();
          payload.paypal_captured_on_client = true;
        }

        const { res, data: result } = await apiPostJson('/api/fines/' + fineId + '/collect', payload);
        if (!res.ok) {
          showAlert('collectFineAlert', result.error || 'PayPal payment failed', 'error');
          return;
        }

        showAlert('collectFineAlert', 'Fine payment successful via Online', 'success');
        await Promise.all([loadFines(), loadFinePayments()]);
        setTimeout(() => {
          cancelFineCollection();
          showAlert('fineAlert', 'Fine collected and payment record saved (Online)', 'success');
        }, 700);
      };

    const onErrorHandler = (err) => {
        const message = err && err.message ? err.message : 'Unable to process PayPal payment';
        showAlert('collectFineAlert', message, 'error');
      };

    const paypalButtons = (collectPayPalConfig && collectPayPalConfig.server_capture_enabled)
      ? window.paypal.Buttons({
          createOrder: async () => {
            const { res, data } = await apiPostJson('/api/fines/' + fineId + '/paypal/create-order', {});
            if (!res.ok || !data.order_id) {
              throw new Error(data.error || 'Failed to create PayPal order');
            }
            return data.order_id;
          },
          onApprove: onApproveHandler,
          onError: onErrorHandler
        })
      : window.paypal.Buttons({
          createOrder: (data, actions) => actions.order.create({
            intent: 'CAPTURE',
            purchase_units: [{
              amount: {
                currency_code: (collectPayPalConfig && collectPayPalConfig.currency) || 'USD',
                value: Number(selectedFineForCollection?.fine_amount || 0).toFixed(2)
              },
              description: 'Library fine payment #' + fineId
            }],
            application_context: {
              shipping_preference: 'NO_SHIPPING',
              user_action: 'PAY_NOW'
            }
          }),
          onApprove: onApproveHandler,
          onError: onErrorHandler
        });

    paypalButtons.render('#collectPaypalButtonContainer');

    collectPayPalButtonsRenderedForFineId = fineId;
  }

  async function toggleCollectPaymentFields() {
    const type = document.getElementById('collectPaymentType').value;
    const onlineWrap = document.getElementById('collectOnlineWrap');
    const offlineWrap = document.getElementById('collectOfflineRefWrap');
    const offlineSubmitBtn = document.getElementById('collectOfflineSubmitBtn');

    if (type === 'Online') {
      onlineWrap.style.display = 'grid';
      offlineWrap.style.display = 'none';
      offlineSubmitBtn.style.display = 'none';
      try {
        await renderCollectPayPalButtons();
      } catch (err) {
        showAlert('collectFineAlert', err.message || 'Failed to initialize PayPal', 'error');
      }
    } else if (type === 'Offline') {
      onlineWrap.style.display = 'none';
      offlineWrap.style.display = 'block';
      offlineSubmitBtn.style.display = 'inline-flex';
    } else {
      onlineWrap.style.display = 'none';
      offlineWrap.style.display = 'none';
      offlineSubmitBtn.style.display = 'inline-flex';
    }
  }

  function goToCollectFineSection() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
    const section = document.getElementById('section-collect-fine');
    if (section) section.classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('open');
  }

  async function openFineCollectionPage(fineId) {
    const fineIdNumber = Number(fineId || 0);
    if (!fineIdNumber) {
      showAlert('fineAlert', 'Invalid fine selected', 'error');
      return;
    }

    const cachedFine = Array.isArray(finesCache)
      ? finesCache.find((row) => Number(row.id || 0) === fineIdNumber)
      : null;
    if (cachedFine) {
      const cachedStatusNorm = String(cachedFine.status || '').trim().toLowerCase();
      if (cachedStatusNorm !== 'pending') {
        showAlert('fineAlert', 'This fine is already collected', 'error');
        loadFines();
        return;
      }
      selectedFineForCollection = cachedFine;
      resetCollectFineForm();
      selectedFineForCollection = cachedFine;
      setCollectFineFields(cachedFine);
      goToCollectFineSection();
      return;
    }

    try {
      const { res, data: fine } = await apiGetJson('/api/fines/' + fineIdNumber);
      if (!res.ok) {
        showAlert('fineAlert', fine.error || 'Failed to load fine details', 'error');
        return;
      }

      const statusNorm = String(fine.status || '').trim().toLowerCase();
      if (statusNorm !== 'pending') {
        showAlert('fineAlert', 'This fine is already collected', 'error');
        loadFines();
        return;
      }

      selectedFineForCollection = fine;
      resetCollectFineForm();
      selectedFineForCollection = fine;
      setCollectFineFields(fine);
      goToCollectFineSection();
    } catch {
      showAlert('fineAlert', 'Failed to load fine details', 'error');
    }
  }

  async function submitFineCollectionForm(ev) {
    ev.preventDefault();

    const fineId = Number(document.getElementById('collectFineId').value || 0);
    const paymentType = document.getElementById('collectPaymentType').value;
    const paymentNotes = document.getElementById('collectPaymentNotes').value.trim();

    if (!fineId) {
      showAlert('collectFineAlert', 'Invalid fine record', 'error');
      return;
    }
    if (!paymentType) {
      showAlert('collectFineAlert', 'Please select payment method', 'error');
      return;
    }

    const payload = {
      payment_type: paymentType,
      payment_notes: paymentNotes
    };

    if (paymentType === 'Offline') {
      const paymentRef = document.getElementById('collectOfflineRef').value.trim();
      if (paymentRef) payload.payment_reference = paymentRef;
    } else {
      showAlert('collectFineAlert', 'For online payment, please use the PayPal button.', 'error');
      return;
    }

    try {
      const { res, data: result } = await apiPostJson('/api/fines/' + fineId + '/collect', payload);
      if (!res.ok) {
        showAlert('collectFineAlert', result.error || 'Failed to process payment', 'error');
        return;
      }

      showAlert('collectFineAlert', 'Fine payment successful via ' + paymentType, 'success');
      await Promise.all([loadFines(), loadFinePayments()]);
      setTimeout(() => {
        cancelFineCollection();
        showAlert('fineAlert', 'Fine collected and payment record saved (' + paymentType + ')', 'success');
      }, 700);
    } catch {
      showAlert('collectFineAlert', 'Failed to process payment', 'error');
    }
  }

  function cancelFineCollection() {
    resetCollectFineForm();
    const finesNav = document.querySelector('.sidebar-nav a[data-section="fines"]');
    navigateTo('fines', finesNav || null);
  }

  function renderFinePayments(rows) {
    const tbody = document.getElementById('finePaymentsTableBody');
    if (!rows || rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No payment records found.</td></tr>';
      return;
    }

    tbody.innerHTML = rows.map((r) => {
      const typeNorm = String(r.payment_type || '').trim().toLowerCase();
      const typeBadge = typeNorm === 'online'
        ? '<span class="badge-online">Online</span>'
        : '<span class="badge-offline">Office/Offline</span>';
      const statusNorm = String(r.payment_status || '').trim().toLowerCase();
      const statusBadge = statusNorm === 'success' || statusNorm === 'completed'
        ? '<span class="badge-collected">Success</span>'
        : statusNorm === 'failed'
        ? '<span class="badge-pending">Failed</span>'
        : escapeHtml(r.payment_status || '-');
      const paidAt = r.paid_at ? new Date(r.paid_at).toLocaleString() : '-';
      return `
        <tr>
          <td>${r.payment_id || r.id || '-'}</td>
          <td>${r.fine_id || '-'}</td>
          <td>${escapeHtml(r.user_name || 'Unknown User')}</td>
          <td>${escapeHtml(r.book_name || 'Unknown Book')}</td>
          <td>&#8377; ${Number(r.amount || 0).toFixed(2)}</td>
          <td>${typeBadge}</td>
          <td>${statusBadge}</td>
          <td>${escapeHtml(r.payment_gateway || '-')}</td>
          <td>${escapeHtml(r.payment_reference || r.transaction_id || '-')}</td>
          <td>${escapeHtml(paidAt)}</td>
        </tr>
      `;
    }).join('');
  }

  async function loadFinePayments() {
    try {
      const { res, data: rows } = await apiGetJson('/api/fine-payments');
      if (!res.ok) {
        showAlert('finePaymentAlert', rows.error || 'Failed to load payment records', 'error');
        return;
      }
      renderFinePayments(Array.isArray(rows) ? rows : []);
    } catch {
      showAlert('finePaymentAlert', 'Failed to load payment records', 'error');
    }
  }

  function openSectionFromHash() {
    const section = String(window.location.hash || '').replace('#', '').trim();
    if (!section) {
      loadDashboard();
      return;
    }

    const supported = ['dashboard', 'users', 'book-master', 'class-master', 'books', 'issue-books', 'fines', 'fine-payments'];
    if (!supported.includes(section)) {
      loadDashboard();
      return;
    }

    const nav = document.querySelector('.sidebar-nav a[data-section="' + section + '"]');
    navigateTo(section, nav || null);
  }

  Promise.all([
    loadBookMasterDropdown().catch(() => {}),
    loadClassMasterDropdown().catch(() => {})
  ]).finally(() => {
    openSectionFromHash();
  });
</script>

</body>
</html>
