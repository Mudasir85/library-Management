generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  librarian
  member
}

enum UserStatus {
  active
  inactive
}

enum BookCondition {
  excellent
  good
  fair
  poor
}

enum Gender {
  male
  female
  other
}

enum MemberType {
  student
  faculty
  public
}

enum MemberStatus {
  active
  suspended
  expired
}

enum TransactionStatus {
  issued
  returned
  overdue
}

enum FineType {
  overdue
  lost
  damage
  membership
  reservation_noshow
}

enum PaymentMethod {
  cash
  card
  online
}

enum FineStatus {
  pending
  paid
  waived
}

enum ReservationStatus {
  active
  fulfilled
  cancelled
  expired
}

model User {
  id           String     @id @default(uuid()) @map("user_id")
  username     String     @unique
  email        String     @unique
  passwordHash String     @map("password_hash")
  fullName     String     @map("full_name")
  role         UserRole
  createdAt    DateTime   @default(now()) @map("created_at")
  lastLogin    DateTime?  @map("last_login")
  status       UserStatus @default(active)

  member             Member?
  issuedTransactions  Transaction[] @relation("IssuedBy")
  returnedTransactions Transaction[] @relation("ReturnedTo")

  @@map("users")
}

model Book {
  id              String        @id @default(uuid()) @map("book_id")
  title           String
  author          String
  isbn            String        @unique
  publisher       String?
  publicationYear Int?          @map("publication_year")
  edition         String?
  category        String
  language        String        @default("English")
  pages           Int?
  shelfLocation   String        @map("shelf_location")
  callNumber      String        @map("call_number")
  totalCopies     Int           @default(1) @map("total_copies")
  availableCopies Int           @map("available_copies")
  condition       BookCondition @default(good)
  purchaseDate    DateTime?     @map("purchase_date") @db.Date
  price           Decimal?      @db.Decimal(10, 2)
  description     String?
  coverImageUrl   String?       @map("cover_image_url")
  isDeleted       Boolean       @default(false) @map("is_deleted")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  transactions Transaction[]
  reservations Reservation[]

  @@index([title])
  @@index([author])
  @@index([isbn])
  @@index([category])
  @@map("books")
}

model Member {
  id                 String       @id @default(uuid()) @map("member_id")
  userId             String       @unique @map("user_id")
  fullName           String       @map("full_name")
  dateOfBirth        DateTime?    @map("date_of_birth") @db.Date
  gender             Gender?
  email              String
  phone              String
  address            String
  city               String
  postalCode         String?      @map("postal_code")
  memberType         MemberType   @map("member_type")
  department         String?
  studentEmployeeId  String?      @map("student_employee_id")
  photoUrl           String?      @map("photo_url")
  registrationDate   DateTime     @default(now()) @map("registration_date") @db.Date
  expiryDate         DateTime     @map("expiry_date") @db.Date
  status             MemberStatus @default(active)
  booksIssuedCount   Int          @default(0) @map("books_issued_count")
  outstandingFines   Decimal      @default(0) @db.Decimal(10, 2) @map("outstanding_fines")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  fines        Fine[]
  reservations Reservation[]

  @@map("members")
}

model Transaction {
  id            String            @id @default(uuid()) @map("transaction_id")
  memberId      String            @map("member_id")
  bookId        String            @map("book_id")
  issueDate     DateTime          @map("issue_date")
  dueDate       DateTime          @map("due_date") @db.Date
  returnDate    DateTime?         @map("return_date")
  renewalCount  Int               @default(0) @map("renewal_count")
  fineAmount    Decimal           @default(0) @db.Decimal(10, 2) @map("fine_amount")
  finePaid      Boolean           @default(false) @map("fine_paid")
  status        TransactionStatus @default(issued)
  issuedById    String?           @map("issued_by")
  returnedToId  String?           @map("returned_to")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  member     Member @relation(fields: [memberId], references: [id])
  book       Book   @relation(fields: [bookId], references: [id])
  issuedBy   User?  @relation("IssuedBy", fields: [issuedById], references: [id])
  returnedTo User?  @relation("ReturnedTo", fields: [returnedToId], references: [id])
  fines      Fine[]

  @@map("transactions")
}

model Fine {
  id            String         @id @default(uuid()) @map("fine_id")
  transactionId String?        @map("transaction_id")
  memberId      String         @map("member_id")
  fineType      FineType       @map("fine_type")
  amount        Decimal        @db.Decimal(10, 2)
  paidAmount    Decimal        @default(0) @db.Decimal(10, 2) @map("paid_amount")
  paymentDate   DateTime?      @map("payment_date")
  paymentMethod PaymentMethod? @map("payment_method")
  status        FineStatus     @default(pending)
  description   String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  transaction Transaction? @relation(fields: [transactionId], references: [id])
  member      Member       @relation(fields: [memberId], references: [id])

  @@map("fines")
}

model Reservation {
  id               String            @id @default(uuid()) @map("reservation_id")
  bookId           String            @map("book_id")
  memberId         String            @map("member_id")
  reservationDate  DateTime          @default(now()) @map("reservation_date")
  status           ReservationStatus @default(active)
  notificationSent Boolean           @default(false) @map("notification_sent")
  expiryDate       DateTime?         @map("expiry_date") @db.Date
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  book   Book   @relation(fields: [bookId], references: [id])
  member Member @relation(fields: [memberId], references: [id])

  @@map("reservations")
}

model Category {
  id               String     @id @default(uuid()) @map("category_id")
  name             String     @unique
  description      String?
  parentCategoryId String?    @map("parent_category_id")
  createdAt        DateTime   @default(now()) @map("created_at")

  parentCategory Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  subCategories  Category[] @relation("CategoryHierarchy")

  @@map("categories")
}

model SystemSetting {
  id              String     @id @default(uuid()) @map("setting_id")
  memberType      MemberType @map("member_type")
  maxBooksAllowed Int        @map("max_books_allowed")
  loanDurationDays Int       @map("loan_duration_days")
  renewalLimit    Int        @map("renewal_limit")
  finePerDay      Decimal    @db.Decimal(10, 2) @map("fine_per_day")
  gracePeriodDays Int        @default(0) @map("grace_period_days")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  @@unique([memberType])
  @@map("system_settings")
}
